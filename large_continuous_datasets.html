


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Large Continuous Data Sets &mdash; pyasdf 0.3.0 documentation</title>
  

  
  
    <link rel="shortcut icon" href="_static/favicon.ico"/>
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="stylesheet" href="_static/my-styles.css" type="text/css" />
  
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  
        <link rel="index" title="Index"
              href="genindex.html"/>
        <link rel="search" title="Search" href="search.html"/>
    <link rel="top" title="pyasdf 0.3.0 documentation" href="index.html"/>
        <link rel="up" title="Detailed Explanations" href="detailed_explanations.html"/>
        <link rel="prev" title="Working With Station Data" href="station_data.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> pyasdf
          

          
            
            <img src="_static/pyasdf_logo.svg" class="logo" />
          
          </a>

          
            
            
              <div class="version">
                0.3.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">API</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="detailed_explanations.html">Detailed Explanations</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="converting_data_asdf.html">Converting Data to ASDF</a></li>
<li class="toctree-l2"><a class="reference internal" href="parallel_processing.html">Parallel Processing</a></li>
<li class="toctree-l2"><a class="reference internal" href="usage_as_context_manager.html">Usage as a Context Manager</a></li>
<li class="toctree-l2"><a class="reference internal" href="deleting_pieces.html">Deleting Pieces of a Data Set</a></li>
<li class="toctree-l2"><a class="reference internal" href="of_tags_and_labels.html">Of Tags and Labels</a></li>
<li class="toctree-l2"><a class="reference internal" href="querying_data.html">Querying a Data Set</a></li>
<li class="toctree-l2"><a class="reference internal" href="station_data.html">Working With Station Data</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Large Continuous Data Sets</a></li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="index.html">pyasdf</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="index.html">Docs</a> &raquo;</li>
      
          <li><a href="detailed_explanations.html">Detailed Explanations</a> &raquo;</li>
      
    <li>Large Continuous Data Sets</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/large_continuous_datasets.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="large-continuous-data-sets">
<h1>Large Continuous Data Sets<a class="headerlink" href="#large-continuous-data-sets" title="Permalink to this headline">Â¶</a></h1>
<p>ASDF can also be used for large continuous data sets. This tutorial
demonstrates it with one year of data from the Bavarian seismic network, all of
which will be stored in a single ASDF file.</p>
<p>When designing an application around ASDF please take a couple of minutes to
think about the granularity at which you want to store the data. It would be
possible to store all waveforms for a single day, or a month, or even several
years from multiple stations, all in the same ASDF file. The best granularity
depends on the specific application. Very large files might be a bit easier to
work with (less bookkeeping) but are harder to move around, backup, and more
prone to corruption through bit rot.</p>
<p>We start with a folder full of MiniSEED files, one per day.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ du -sh EHZ.D
<span class="m">7</span>.3G    EHZ.D

$ ls EHZ.D <span class="p">|</span> wc -l
<span class="m">365</span>
</pre></div>
</div>
<p>A simple script writes everything into a single ASDF file. <a class="reference external" href="https://pypi.python.org/pypi/tqdm">tqdm</a> (install with <code class="docutils literal"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">tqdm</span></code>) is a
very simple way to add a progress bar to a loop. Feel free to leave it out.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>import glob
from tqdm import tqdm
from pyasdf import ASDFDataSet

<span class="nv">ds</span> <span class="o">=</span> ASDFDataSet<span class="o">(</span><span class="s2">&quot;out_gzip3.h5&quot;</span>, <span class="nv">compression</span><span class="o">=</span><span class="s2">&quot;gzip-3&quot;</span><span class="o">)</span>

<span class="k">for</span> filename in tqdm<span class="o">(</span>glob.glob<span class="o">(</span><span class="s2">&quot;./EHZ.D/BW.ALTM.*&quot;</span><span class="o">))</span>:
    ds.append_waveforms<span class="o">(</span>filename, <span class="nv">tag</span><span class="o">=</span><span class="s2">&quot;raw_recording&quot;</span><span class="o">)</span>
</pre></div>
</div>
<p>Note that this script uses the
<a class="reference internal" href="asdf_data_set.html#pyasdf.asdf_data_set.ASDFDataSet.append_waveforms" title="pyasdf.asdf_data_set.ASDFDataSet.append_waveforms"><code class="xref py py-meth docutils literal"><span class="pre">append_waveforms()</span></code></a> method. This will,
assuming two files are exactly adjacent (last sample of first file and first
sample of next file are exactly one delta apart), store both in a single, large
array which might be advantageous for some access patterns. It can be
completely replaced by the
<a class="reference internal" href="asdf_data_set.html#pyasdf.asdf_data_set.ASDFDataSet.add_waveforms" title="pyasdf.asdf_data_set.ASDFDataSet.add_waveforms"><code class="xref py py-meth docutils literal"><span class="pre">add_waveforms()</span></code></a> method which will not
do the merging. A case by case choice has to be made to determine which is more
suitable for any given application.</p>
<p>Also note that compression can have quite a strong effect but the writing and
reading speed will naturally decrease. The compression option can be set when
initializing the ASDF file. Here are some results for this particular data set:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>du -sh *.h5
<span class="m">4</span>.8G    out_gzip3.h5
23G     out_uncompressed.h5
</pre></div>
</div>
<p>The compression is even more efficient than the original STEIM encoding. The
uncompressed version is faster to create though (of course this, like all
benchmarks, depends on a large number of factors).</p>
<p>The normal access pattern for ASDF breaks a bit here as it would potentially
load a lot of data into memory at one go. <code class="docutils literal"><span class="pre">pyasdf</span></code> prevents accidental use
when trying to load a full year into memory at once:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">ds</span><span class="o">.</span><span class="n">waveforms</span><span class="o">.</span><span class="n">BW_ALTM</span><span class="o">.</span><span class="n">raw_recording</span>
<span class="go">---------------------------------------------------------------------------</span>
<span class="go">ASDFValueError                            Traceback (most recent call last)</span>

<span class="gp">...</span>

<span class="go">ASDFValueError: All waveforms for station &#39;BW.ALTM&#39; and item &#39;raw_recording&#39;</span>
<span class="go">would require &#39;23897.74 MB of memory. The current limit is 1024.00 MB. Adjust</span>
<span class="go">by setting &#39;ASDFDataSet.single_item_read_limit_in_mb&#39; or use a different</span>
<span class="go">method to read the waveform data.</span>
</pre></div>
</div>
<p>Thus either adjust the setting as suggested, or, much better, use a different
method to access the data:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">ds</span><span class="o">.</span><span class="n">get_waveforms</span><span class="p">(</span><span class="n">network</span><span class="o">=</span><span class="s2">&quot;BW&quot;</span><span class="p">,</span> <span class="n">station</span><span class="o">=</span><span class="s2">&quot;ALTM&quot;</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="s2">&quot;EHZ&quot;</span><span class="p">,</span>
<span class="go">                     starttime=obspy.UTCDateTime(2015, 3, 11),</span>
<span class="go">                     endtime=obspy.UTCDateTime(2015, 3, 12), tag=&quot;raw_recording&quot;)</span>
<span class="go">1 Trace(s) in Stream:</span>
<span class="go">BW.ALTM..EHZ | 2015-03-10T23:59:59... - 2015-03-12T00:00:00... | 200.0 Hz, 17280002 samples</span>
</pre></div>
</div>
<p>This will only extract sample at exactly the required times making it very
suitable for very big data arrays.</p>
<p>Another example of this is to write a simple loop over every hour in the year:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">starttime</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="mi">2015</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">endtime</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="mi">2016</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="k">while</span> <span class="n">starttime</span> <span class="o">+</span> <span class="mi">3600</span> <span class="o">&lt;</span> <span class="n">endtime</span><span class="p">:</span>
    <span class="n">st</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">get_waveforms</span><span class="p">(</span><span class="n">network</span><span class="o">=</span><span class="s2">&quot;BW&quot;</span><span class="p">,</span> <span class="n">station</span><span class="o">=</span><span class="s2">&quot;ALTM&quot;</span><span class="p">,</span>
                          <span class="n">location</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="s2">&quot;EHZ&quot;</span><span class="p">,</span>
                          <span class="n">starttime</span><span class="o">=</span><span class="n">starttime</span><span class="p">,</span> <span class="n">endtime</span><span class="o">=</span><span class="n">starttime</span> <span class="o">+</span> <span class="mi">3600</span><span class="p">,</span>
                          <span class="n">tag</span><span class="o">=</span><span class="s2">&quot;raw_recording&quot;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">st</span><span class="p">)</span>
    <span class="n">starttime</span> <span class="o">+=</span> <span class="mi">3600</span>
</pre></div>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
      
        <a href="station_data.html" class="btn btn-neutral" title="Working With Station Data" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2014-2016, Lion Krischer.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'0.3.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>